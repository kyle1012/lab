{"version":3,"names":["fetchWithNetworkError","ErrorWithCause","AuthError","packageJson","stripSlash","url","replace","handleJSONResponse","res","status","jsonPromise","json","errMsg","statusText","errData","message","requestId","Error","Symbol","for","RequestClient","constructor","uppy","opts","skip","response","onReceiveResponse","bind","allowedHeaders","preflightDone","companionHeaders","setCompanionHeaders","headers","hostname","companion","getState","host","companionUrl","Promise","resolve","defaultHeaders","state","has","get","setState","preflight","path","slice","fetch","method","then","split","map","headerName","trim","toLowerCase","catch","err","log","preflightAndHeaders","all","Object","keys","forEach","header","includes","skipPostResponse","credentials","companionCookiesRule","post","data","body","JSON","stringify","delete","test","isAuthError","cause","reject","VERSION","version","Accept"],"sources":["RequestClient.js"],"sourcesContent":["'use strict'\n\nimport fetchWithNetworkError from '@uppy/utils/lib/fetchWithNetworkError'\nimport ErrorWithCause from '@uppy/utils/lib/ErrorWithCause'\nimport AuthError from './AuthError.js'\n\nimport packageJson from '../package.json'\n\n// Remove the trailing slash so we can always safely append /xyz.\nfunction stripSlash (url) {\n  return url.replace(/\\/$/, '')\n}\n\nasync function handleJSONResponse (res) {\n  if (res.status === 401) {\n    throw new AuthError()\n  }\n\n  const jsonPromise = res.json()\n\n  if (res.status < 200 || res.status > 300) {\n    let errMsg = `Failed request with status: ${res.status}. ${res.statusText}`\n    try {\n      const errData = await jsonPromise\n      errMsg = errData.message ? `${errMsg} message: ${errData.message}` : errMsg\n      errMsg = errData.requestId ? `${errMsg} request-Id: ${errData.requestId}` : errMsg\n    } finally {\n      // eslint-disable-next-line no-unsafe-finally\n      throw new Error(errMsg)\n    }\n  }\n  return jsonPromise\n}\n\nexport default class RequestClient {\n  static VERSION = packageJson.version\n\n  #companionHeaders\n\n  #getPostResponseFunc = skip => response => (skip ? response : this.onReceiveResponse(response))\n\n  constructor (uppy, opts) {\n    this.uppy = uppy\n    this.opts = opts\n    this.onReceiveResponse = this.onReceiveResponse.bind(this)\n    this.allowedHeaders = ['accept', 'content-type', 'uppy-auth-token']\n    this.preflightDone = false\n    this.#companionHeaders = opts?.companionHeaders\n  }\n\n  setCompanionHeaders (headers) {\n    this.#companionHeaders = headers\n  }\n\n  [Symbol.for('uppy test: getCompanionHeaders')] () { return this.#companionHeaders }\n\n  get hostname () {\n    const { companion } = this.uppy.getState()\n    const host = this.opts.companionUrl\n    return stripSlash(companion && companion[host] ? companion[host] : host)\n  }\n\n  static defaultHeaders = {\n    Accept: 'application/json',\n    'Content-Type': 'application/json',\n    'Uppy-Versions': `@uppy/companion-client=${RequestClient.VERSION}`,\n  }\n\n  headers () {\n    return Promise.resolve({\n      ...RequestClient.defaultHeaders,\n      ...this.#companionHeaders,\n    })\n  }\n\n  onReceiveResponse (response) {\n    const state = this.uppy.getState()\n    const companion = state.companion || {}\n    const host = this.opts.companionUrl\n    const { headers } = response\n    // Store the self-identified domain name for the Companion instance we just hit.\n    if (headers.has('i-am') && headers.get('i-am') !== companion[host]) {\n      this.uppy.setState({\n        companion: { ...companion, [host]: headers.get('i-am') },\n      })\n    }\n    return response\n  }\n\n  #getUrl (url) {\n    if (/^(https?:|)\\/\\//.test(url)) {\n      return url\n    }\n    return `${this.hostname}/${url}`\n  }\n\n  #errorHandler (method, path) {\n    return (err) => {\n      if (!err?.isAuthError) {\n        // eslint-disable-next-line no-param-reassign\n        err = new ErrorWithCause(`Could not ${method} ${this.#getUrl(path)}`, { cause: err })\n      }\n      return Promise.reject(err)\n    }\n  }\n\n  preflight (path) {\n    if (this.preflightDone) {\n      return Promise.resolve(this.allowedHeaders.slice())\n    }\n\n    return fetch(this.#getUrl(path), {\n      method: 'OPTIONS',\n    })\n      .then((response) => {\n        if (response.headers.has('access-control-allow-headers')) {\n          this.allowedHeaders = response.headers.get('access-control-allow-headers')\n            .split(',').map((headerName) => headerName.trim().toLowerCase())\n        }\n        this.preflightDone = true\n        return this.allowedHeaders.slice()\n      })\n      .catch((err) => {\n        this.uppy.log(`[CompanionClient] unable to make preflight request ${err}`, 'warning')\n        this.preflightDone = true\n        return this.allowedHeaders.slice()\n      })\n  }\n\n  preflightAndHeaders (path) {\n    return Promise.all([this.preflight(path), this.headers()])\n      .then(([allowedHeaders, headers]) => {\n        // filter to keep only allowed Headers\n        Object.keys(headers).forEach((header) => {\n          if (!allowedHeaders.includes(header.toLowerCase())) {\n            this.uppy.log(`[CompanionClient] excluding disallowed header ${header}`)\n            delete headers[header] // eslint-disable-line no-param-reassign\n          }\n        })\n\n        return headers\n      })\n  }\n\n  get (path, skipPostResponse) {\n    const method = 'get'\n    return this.preflightAndHeaders(path)\n      .then((headers) => fetchWithNetworkError(this.#getUrl(path), {\n        method,\n        headers,\n        credentials: this.opts.companionCookiesRule || 'same-origin',\n      }))\n      .then(this.#getPostResponseFunc(skipPostResponse))\n      .then(handleJSONResponse)\n      .catch(this.#errorHandler(method, path))\n  }\n\n  post (path, data, skipPostResponse) {\n    const method = 'post'\n    return this.preflightAndHeaders(path)\n      .then((headers) => fetchWithNetworkError(this.#getUrl(path), {\n        method,\n        headers,\n        credentials: this.opts.companionCookiesRule || 'same-origin',\n        body: JSON.stringify(data),\n      }))\n      .then(this.#getPostResponseFunc(skipPostResponse))\n      .then(handleJSONResponse)\n      .catch(this.#errorHandler(method, path))\n  }\n\n  delete (path, data, skipPostResponse) {\n    const method = 'delete'\n    return this.preflightAndHeaders(path)\n      .then((headers) => fetchWithNetworkError(`${this.hostname}/${path}`, {\n        method,\n        headers,\n        credentials: this.opts.companionCookiesRule || 'same-origin',\n        body: data ? JSON.stringify(data) : null,\n      }))\n      .then(this.#getPostResponseFunc(skipPostResponse))\n      .then(handleJSONResponse)\n      .catch(this.#errorHandler(method, path))\n  }\n}\n"],"mappings":"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"}