{"ast":null,"code":"'use strict';\n\nimport \"core-js/modules/web.dom-exception.stack.js\";\nimport RequestClient from './RequestClient.js';\nimport * as tokenStorage from './tokenStorage.js';\nconst getName = id => {\n  return id.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');\n};\nexport default class Provider extends RequestClient {\n  constructor(uppy, opts) {\n    super(uppy, opts);\n    this.provider = opts.provider;\n    this.id = this.provider;\n    this.name = this.opts.name || getName(this.id);\n    this.pluginId = this.opts.pluginId;\n    this.tokenKey = `companion-${this.pluginId}-auth-token`;\n    this.companionKeysParams = this.opts.companionKeysParams;\n    this.preAuthToken = null;\n  }\n  headers() {\n    return Promise.all([super.headers(), this.getAuthToken()]).then(_ref => {\n      let [headers, token] = _ref;\n      const authHeaders = {};\n      if (token) {\n        authHeaders['uppy-auth-token'] = token;\n      }\n      if (this.companionKeysParams) {\n        authHeaders['uppy-credentials-params'] = btoa(JSON.stringify({\n          params: this.companionKeysParams\n        }));\n      }\n      return {\n        ...headers,\n        ...authHeaders\n      };\n    });\n  }\n  onReceiveResponse(response) {\n    response = super.onReceiveResponse(response); // eslint-disable-line no-param-reassign\n\n    const plugin = this.uppy.getPlugin(this.pluginId);\n    const oldAuthenticated = plugin.getPluginState().authenticated;\n    const authenticated = oldAuthenticated ? response.status !== 401 : response.status < 400;\n    plugin.setPluginState({\n      authenticated\n    });\n    return response;\n  }\n  setAuthToken(token) {\n    return this.uppy.getPlugin(this.pluginId).storage.setItem(this.tokenKey, token);\n  }\n  getAuthToken() {\n    return this.uppy.getPlugin(this.pluginId).storage.getItem(this.tokenKey);\n  }\n  /**\n   * Ensure we have a preauth token if necessary. Attempts to fetch one if we don't,\n   * or rejects if loading one fails.\n   */\n\n  async ensurePreAuth() {\n    if (this.companionKeysParams && !this.preAuthToken) {\n      await this.fetchPreAuthToken();\n      if (!this.preAuthToken) {\n        throw new Error('Could not load authentication data required for third-party login. Please try again later.');\n      }\n    }\n  }\n  authUrl(queries) {\n    if (queries === void 0) {\n      queries = {};\n    }\n    const params = new URLSearchParams(queries);\n    if (this.preAuthToken) {\n      params.set('uppyPreAuthToken', this.preAuthToken);\n    }\n    return `${this.hostname}/${this.id}/connect?${params}`;\n  }\n  fileUrl(id) {\n    return `${this.hostname}/${this.id}/get/${id}`;\n  }\n  async fetchPreAuthToken() {\n    if (!this.companionKeysParams) {\n      return;\n    }\n    try {\n      const res = await this.post(`${this.id}/preauth/`, {\n        params: this.companionKeysParams\n      });\n      this.preAuthToken = res.token;\n    } catch (err) {\n      this.uppy.log(`[CompanionClient] unable to fetch preAuthToken ${err}`, 'warning');\n    }\n  }\n  list(directory) {\n    return this.get(`${this.id}/list/${directory || ''}`);\n  }\n  logout() {\n    return this.get(`${this.id}/logout`).then(response => Promise.all([response, this.uppy.getPlugin(this.pluginId).storage.removeItem(this.tokenKey)])).then(_ref2 => {\n      let [response] = _ref2;\n      return response;\n    });\n  }\n  static initPlugin(plugin, opts, defaultOpts) {\n    /* eslint-disable no-param-reassign */\n    plugin.type = 'acquirer';\n    plugin.files = [];\n    if (defaultOpts) {\n      plugin.opts = {\n        ...defaultOpts,\n        ...opts\n      };\n    }\n    if (opts.serverUrl || opts.serverPattern) {\n      throw new Error('`serverUrl` and `serverPattern` have been renamed to `companionUrl` and `companionAllowedHosts` respectively in the 0.30.5 release. Please consult the docs (for example, https://uppy.io/docs/instagram/ for the Instagram plugin) and use the updated options.`');\n    }\n    if (opts.companionAllowedHosts) {\n      const pattern = opts.companionAllowedHosts; // validate companionAllowedHosts param\n\n      if (typeof pattern !== 'string' && !Array.isArray(pattern) && !(pattern instanceof RegExp)) {\n        throw new TypeError(`${plugin.id}: the option \"companionAllowedHosts\" must be one of string, Array, RegExp`);\n      }\n      plugin.opts.companionAllowedHosts = pattern;\n    } else if (/^(?!https?:\\/\\/).*$/i.test(opts.companionUrl)) {\n      // does not start with https://\n      plugin.opts.companionAllowedHosts = `https://${opts.companionUrl.replace(/^\\/\\//, '')}`;\n    } else {\n      plugin.opts.companionAllowedHosts = new URL(opts.companionUrl).origin;\n    }\n    plugin.storage = plugin.opts.storage || tokenStorage;\n    /* eslint-enable no-param-reassign */\n  }\n}","map":{"version":3,"names":["RequestClient","tokenStorage","getName","id","split","map","s","charAt","toUpperCase","slice","join","Provider","constructor","uppy","opts","provider","name","pluginId","tokenKey","companionKeysParams","preAuthToken","headers","Promise","all","getAuthToken","then","_ref","token","authHeaders","btoa","JSON","stringify","params","onReceiveResponse","response","plugin","getPlugin","oldAuthenticated","getPluginState","authenticated","status","setPluginState","setAuthToken","storage","setItem","getItem","ensurePreAuth","fetchPreAuthToken","Error","authUrl","queries","URLSearchParams","set","hostname","fileUrl","res","post","err","log","list","directory","get","logout","removeItem","_ref2","initPlugin","defaultOpts","type","files","serverUrl","serverPattern","companionAllowedHosts","pattern","Array","isArray","RegExp","TypeError","test","companionUrl","replace","URL","origin"],"sources":["/lab/node_modules/@uppy/companion-client/lib/Provider.js"],"sourcesContent":["'use strict';\n\nimport RequestClient from './RequestClient.js';\nimport * as tokenStorage from './tokenStorage.js';\n\nconst getName = id => {\n  return id.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');\n};\n\nexport default class Provider extends RequestClient {\n  constructor(uppy, opts) {\n    super(uppy, opts);\n    this.provider = opts.provider;\n    this.id = this.provider;\n    this.name = this.opts.name || getName(this.id);\n    this.pluginId = this.opts.pluginId;\n    this.tokenKey = `companion-${this.pluginId}-auth-token`;\n    this.companionKeysParams = this.opts.companionKeysParams;\n    this.preAuthToken = null;\n  }\n\n  headers() {\n    return Promise.all([super.headers(), this.getAuthToken()]).then(_ref => {\n      let [headers, token] = _ref;\n      const authHeaders = {};\n\n      if (token) {\n        authHeaders['uppy-auth-token'] = token;\n      }\n\n      if (this.companionKeysParams) {\n        authHeaders['uppy-credentials-params'] = btoa(JSON.stringify({\n          params: this.companionKeysParams\n        }));\n      }\n\n      return { ...headers,\n        ...authHeaders\n      };\n    });\n  }\n\n  onReceiveResponse(response) {\n    response = super.onReceiveResponse(response); // eslint-disable-line no-param-reassign\n\n    const plugin = this.uppy.getPlugin(this.pluginId);\n    const oldAuthenticated = plugin.getPluginState().authenticated;\n    const authenticated = oldAuthenticated ? response.status !== 401 : response.status < 400;\n    plugin.setPluginState({\n      authenticated\n    });\n    return response;\n  }\n\n  setAuthToken(token) {\n    return this.uppy.getPlugin(this.pluginId).storage.setItem(this.tokenKey, token);\n  }\n\n  getAuthToken() {\n    return this.uppy.getPlugin(this.pluginId).storage.getItem(this.tokenKey);\n  }\n  /**\n   * Ensure we have a preauth token if necessary. Attempts to fetch one if we don't,\n   * or rejects if loading one fails.\n   */\n\n\n  async ensurePreAuth() {\n    if (this.companionKeysParams && !this.preAuthToken) {\n      await this.fetchPreAuthToken();\n\n      if (!this.preAuthToken) {\n        throw new Error('Could not load authentication data required for third-party login. Please try again later.');\n      }\n    }\n  }\n\n  authUrl(queries) {\n    if (queries === void 0) {\n      queries = {};\n    }\n\n    const params = new URLSearchParams(queries);\n\n    if (this.preAuthToken) {\n      params.set('uppyPreAuthToken', this.preAuthToken);\n    }\n\n    return `${this.hostname}/${this.id}/connect?${params}`;\n  }\n\n  fileUrl(id) {\n    return `${this.hostname}/${this.id}/get/${id}`;\n  }\n\n  async fetchPreAuthToken() {\n    if (!this.companionKeysParams) {\n      return;\n    }\n\n    try {\n      const res = await this.post(`${this.id}/preauth/`, {\n        params: this.companionKeysParams\n      });\n      this.preAuthToken = res.token;\n    } catch (err) {\n      this.uppy.log(`[CompanionClient] unable to fetch preAuthToken ${err}`, 'warning');\n    }\n  }\n\n  list(directory) {\n    return this.get(`${this.id}/list/${directory || ''}`);\n  }\n\n  logout() {\n    return this.get(`${this.id}/logout`).then(response => Promise.all([response, this.uppy.getPlugin(this.pluginId).storage.removeItem(this.tokenKey)])).then(_ref2 => {\n      let [response] = _ref2;\n      return response;\n    });\n  }\n\n  static initPlugin(plugin, opts, defaultOpts) {\n    /* eslint-disable no-param-reassign */\n    plugin.type = 'acquirer';\n    plugin.files = [];\n\n    if (defaultOpts) {\n      plugin.opts = { ...defaultOpts,\n        ...opts\n      };\n    }\n\n    if (opts.serverUrl || opts.serverPattern) {\n      throw new Error('`serverUrl` and `serverPattern` have been renamed to `companionUrl` and `companionAllowedHosts` respectively in the 0.30.5 release. Please consult the docs (for example, https://uppy.io/docs/instagram/ for the Instagram plugin) and use the updated options.`');\n    }\n\n    if (opts.companionAllowedHosts) {\n      const pattern = opts.companionAllowedHosts; // validate companionAllowedHosts param\n\n      if (typeof pattern !== 'string' && !Array.isArray(pattern) && !(pattern instanceof RegExp)) {\n        throw new TypeError(`${plugin.id}: the option \"companionAllowedHosts\" must be one of string, Array, RegExp`);\n      }\n\n      plugin.opts.companionAllowedHosts = pattern;\n    } else if (/^(?!https?:\\/\\/).*$/i.test(opts.companionUrl)) {\n      // does not start with https://\n      plugin.opts.companionAllowedHosts = `https://${opts.companionUrl.replace(/^\\/\\//, '')}`;\n    } else {\n      plugin.opts.companionAllowedHosts = new URL(opts.companionUrl).origin;\n    }\n\n    plugin.storage = plugin.opts.storage || tokenStorage;\n    /* eslint-enable no-param-reassign */\n  }\n\n}"],"mappings":"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"},"metadata":{},"sourceType":"module"}