{"version":3,"file":"validation.mjs","names":["useForm","useProxiedModel","computed","onBeforeMount","onBeforeUnmount","onMounted","ref","unref","watch","getCurrentInstanceName","getUid","propsFactory","wrapInArray","makeValidationProps","disabled","Boolean","error","errorMessages","type","Array","String","default","maxErrors","Number","name","label","readonly","rules","modelValue","validationValue","useValidation","props","id","model","validationModel","undefined","value","form","internalErrorMessages","isPristine","isDirty","length","isDisabled","isReadonly","isValid","isValidating","validationClasses","uid","register","validate","reset","resetValidation","unregister","update","results","rule","handler","result","console","warn","push"],"sources":["../../src/composables/validation.ts"],"sourcesContent":["// Composables\nimport { useForm } from '@/composables/form'\nimport { useProxiedModel } from '@/composables/proxiedModel'\n\n// Utilities\nimport { computed, onBeforeMount, onBeforeUnmount, onMounted, ref, unref, watch } from 'vue'\nimport { getCurrentInstanceName, getUid, propsFactory, wrapInArray } from '@/util'\n\n// Types\nimport type { PropType } from 'vue'\nimport type { MaybeRef } from '@/util'\n\nexport type ValidationResult = string | boolean\nexport type ValidationRule =\n  | ValidationResult\n  | PromiseLike<ValidationResult>\n  | ((value: any) => ValidationResult)\n  | ((value: any) => PromiseLike<ValidationResult>)\n\nexport interface ValidationProps {\n  disabled: boolean\n  error: boolean\n  errorMessages: string | string[]\n  maxErrors: string | number\n  name: string | undefined\n  label: string | undefined\n  readonly: boolean\n  rules: ValidationRule[]\n  modelValue: any\n  'onUpdate:modelValue': ((val: any) => void) | undefined\n  validationValue: any\n}\n\nexport const makeValidationProps = propsFactory({\n  disabled: Boolean,\n  error: Boolean,\n  errorMessages: {\n    type: [Array, String] as PropType<string | string[]>,\n    default: () => ([]),\n  },\n  maxErrors: {\n    type: [Number, String],\n    default: 1,\n  },\n  name: String,\n  label: String,\n  readonly: Boolean,\n  rules: {\n    type: Array as PropType<ValidationRule[]>,\n    default: () => ([]),\n  },\n  modelValue: null,\n  validationValue: null,\n}, 'validation')\n\nexport function useValidation (\n  props: ValidationProps,\n  name = getCurrentInstanceName(),\n  id: MaybeRef<string | number> = getUid(),\n) {\n  const model = useProxiedModel(props, 'modelValue')\n  const validationModel = computed(() => props.validationValue === undefined ? model.value : props.validationValue)\n  const form = useForm()\n  const internalErrorMessages = ref<string[]>([])\n  const isPristine = ref(true)\n  const isDirty = computed(() => !!(\n    wrapInArray(model.value === '' ? null : model.value).length ||\n    wrapInArray(validationModel.value === '' ? null : validationModel.value).length\n  ))\n  const isDisabled = computed(() => !!(props.disabled || form?.isDisabled.value))\n  const isReadonly = computed(() => !!(props.readonly || form?.isReadonly.value))\n  const errorMessages = computed(() => {\n    return props.errorMessages.length\n      ? wrapInArray(props.errorMessages)\n      : internalErrorMessages.value\n  })\n  const isValid = computed(() => {\n    if (props.error || errorMessages.value.length) return false\n    if (!props.rules.length) return true\n\n    return isPristine.value ? null : true\n  })\n  const isValidating = ref(false)\n  const validationClasses = computed(() => {\n    return {\n      [`${name}--error`]: isValid.value === false,\n      [`${name}--dirty`]: isDirty.value,\n      [`${name}--disabled`]: isDisabled.value,\n      [`${name}--readonly`]: isReadonly.value,\n    }\n  })\n\n  const uid = computed(() => props.name ?? unref(id))\n\n  onBeforeMount(() => {\n    form?.register({\n      id: uid.value,\n      validate,\n      reset,\n      resetValidation,\n    })\n  })\n\n  onBeforeUnmount(() => {\n    form?.unregister(uid.value)\n  })\n\n  // Set initial valid state, for inputs that might not have rules\n  onMounted(() => form?.update(uid.value, isValid.value, errorMessages.value))\n\n  watch(validationModel, () => {\n    if (validationModel.value != null) validate()\n  })\n\n  watch(isValid, () => {\n    form?.update(uid.value, isValid.value, errorMessages.value)\n  })\n\n  function reset () {\n    resetValidation()\n    model.value = null\n  }\n\n  function resetValidation () {\n    isPristine.value = true\n    internalErrorMessages.value = []\n  }\n\n  async function validate () {\n    const results = []\n\n    isValidating.value = true\n\n    for (const rule of props.rules) {\n      if (results.length >= (props.maxErrors || 1)) {\n        break\n      }\n\n      const handler = typeof rule === 'function' ? rule : () => rule\n      const result = await handler(validationModel.value)\n\n      if (result === true) continue\n\n      if (typeof result !== 'string') {\n        // eslint-disable-next-line no-console\n        console.warn(`${result} is not a valid value. Rule functions must return boolean true or a string.`)\n\n        continue\n      }\n\n      results.push(result)\n    }\n\n    internalErrorMessages.value = results\n    isValidating.value = false\n    isPristine.value = false\n\n    return internalErrorMessages.value\n  }\n\n  return {\n    errorMessages,\n    isDirty,\n    isDisabled,\n    isReadonly,\n    isPristine,\n    isValid,\n    isValidating,\n    reset,\n    resetValidation,\n    validate,\n    validationClasses,\n  }\n}\n"],"mappings":"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"}